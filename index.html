<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LaTeX2Word - Convert LaTeX to Word</title>

<link rel="stylesheet" href="./indexStyles.css">
<link rel="stylesheet" href="./assets/Temml-Latin-Modern.css">

<script src="./assets/temml.min.js"></script>
<script src="./assets/mhchem.min.js"></script>
<script src="./assets/physics.js"></script>
<script src="./assets/texvc.js"></script>
<script src="./xml-formatter.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
</head>

<body>
<main>
<nav>
   <ul>
     <li><a href="https://github.com/June976/latex2word" style="color: orange;">GitHub</a></li>
     <li><a href="./refs.html" style="color: lime;">Functions</a></li>
     <li><a href="https://temml.org" style="color: brown;">Installation</a></li>
   </ul>
</nav>

<h1 id="title">
 
  <math id="math-title" xmlns="http://www.w3.org/1998/Math/MathML" class="temml" style="background: linear-gradient(to right, orange, lime, brown); -webkit-background-clip: text; color: transparent;">
    <mrow>
      <mtext >L</mtext><mspace width="0.05em"></mspace>
      <mpadded voffset="-0.2em">
        <mtext>a</mtext>
      </mpadded><mspace width="0.05em"></mspace>
      <mtext>T</mtext><mspace width="0.05em"></mspace>
      <mpadded voffset="0.2em">
        <mtext>e</mtext>
      </mpadded><mspace width="0.05em"></mspace>
      <mtext>X</mtext>
    </mrow>
    <mrow>
      <mtext>2</mtext><mspace width="0.05em"></mspace>
      <mpadded voffset="-0.2em">
        <mtext>W</mtext>
      </mpadded><mspace width="0.05em"></mspace>
      <mtext>o</mtext><mspace width="0.05em"></mspace>
      <mpadded voffset="0.2em">
        <mtext>r</mtext>
      </mpadded><mspace width="0.05em"></mspace>
      <mtext>d</mtext>
    </mrow>
  </math>
  
</h1>
 
<article>
  <section id="demo-parent">
    <p>将LaTeX公式转成Word中的公式。</p>
    <p>Translate LaTeX equations into Word equations.</p>

    <p></p>

    <div id="demoinput", class="wide">
      <div id="input">
        <div>Input:</div>
        <textarea class="ioArea" id="demoSource" spellcheck="false" wrap="soft">\def\d{\mathrm{d}}\oint_C \vec{B}\circ \d\vec{l} = \mu_0 \left( I_{\text{enc}} + \varepsilon_0 \frac{\d}{\d t} \int_S {\vec{E} \circ \hat{n}}\; \d a \right)</textarea>
      </div>
    </div>
    
    <div id="demo">
    <div id="output">
      <div>Output(Temml):</div>
      <div class="ioArea" id="demoRendering">
        <div id="math-output">
          <math id="mathTemml-Output" display="block"><mrow><msub><mo movablelimits="false">∮</mo><mi>C</mi></msub><mover accent="true"><mi>B</mi><mo stretchy="false">⃗</mo></mover><mo>∘</mo><mpadded lspace="0" width="+0em"><mi mathvariant="normal">d</mi></mpadded><mover accent="true"><mi>l</mi><mo stretchy="false">⃗</mo></mover><mo>=</mo><msub><mi>μ</mi><mn>0</mn></msub><mrow><mo fence="true" form="prefix">(</mo><msub><mi>I</mi><mtext>enc</mtext></msub><mo>+</mo><msub><mi>ε</mi><mn>0</mn></msub><mfrac><mpadded lspace="0" width="+0em"><mi mathvariant="normal">d</mi></mpadded><mrow><mpadded lspace="0" width="+0em"><mi mathvariant="normal">d</mi></mpadded><mi>t</mi></mrow></mfrac><msub><mo movablelimits="false">∫</mo><mi>S</mi></msub><mover accent="true"><mi>E</mi><mo stretchy="false">⃗</mo></mover><mo>∘</mo><mover accent="true"><mi>n</mi><mo stretchy="false">^</mo></mover><mspace width="0.2778em"></mspace><mpadded lspace="0" width="+0em"><mi mathvariant="normal">d</mi></mpadded><mi>a</mi><mo fence="true" form="postfix">)</mo></mrow></mrow></math>
        </div>
      </div>
    </div>
    <div id="spacer"></div>

    <div id="output">
      <div>Output(KaTeX):</div>
      <div class="ioArea" id="demoRendering">
        <div id="captureArea">
          <div id="katex-output">
          </div>
        </div>
      </div>
    </div>

    <div id="output">
      <div>Output(MathML):</div>
      <div class="ioArea" id="demoRendering">
        <div id="mml-output">
          <math display="block"><mrow><msub><mo movablelimits="false">∮</mo><mi>C</mi></msub><mover accent="true"><mi>B</mi><mo stretchy="false">⃗</mo></mover><mo>∘</mo><mpadded lspace="0" width="+0em"><mi mathvariant="normal">d</mi></mpadded><mover accent="true"><mi>l</mi><mo stretchy="false">⃗</mo></mover><mo>=</mo><msub><mi>μ</mi><mn>0</mn></msub><mrow><mo fence="true" form="prefix">(</mo><msub><mi>I</mi><mtext>enc</mtext></msub><mo>+</mo><msub><mi>ε</mi><mn>0</mn></msub><mfrac><mpadded lspace="0" width="+0em"><mi mathvariant="normal">d</mi></mpadded><mrow><mpadded lspace="0" width="+0em"><mi mathvariant="normal">d</mi></mpadded><mi>t</mi></mrow></mfrac><msub><mo movablelimits="false">∫</mo><mi>S</mi></msub><mover accent="true"><mi>E</mi><mo stretchy="false">⃗</mo></mover><mo>∘</mo><mover accent="true"><mi>n</mi><mo stretchy="false">^</mo></mover><mspace width="0.2778em"></mspace><mpadded lspace="0" width="+0em"><mi mathvariant="normal">d</mi></mpadded><mi>a</mi><mo fence="true" form="postfix">)</mo></mrow></mrow></math>
        </div>
      </div>
    </div>
    <div id="spacer"></div>

    <div id="output">
      <div>Output(Flat MathML):</div>
      <div class="ioArea" id="demoRendering">
        <div id="flatmml-output">
          <math display="block"><mrow><msub><mo movablelimits="false">∮</mo><mi>C</mi></msub><mover accent="true"><mi>B</mi><mo stretchy="false">⃗</mo></mover><mo>∘</mo><mpadded lspace="0" width="+0em"><mi mathvariant="normal">d</mi></mpadded><mover accent="true"><mi>l</mi><mo stretchy="false">⃗</mo></mover><mo>=</mo><msub><mi>μ</mi><mn>0</mn></msub><mrow><mo fence="true" form="prefix">(</mo><msub><mi>I</mi><mtext>enc</mtext></msub><mo>+</mo><msub><mi>ε</mi><mn>0</mn></msub><mfrac><mpadded lspace="0" width="+0em"><mi mathvariant="normal">d</mi></mpadded><mrow><mpadded lspace="0" width="+0em"><mi mathvariant="normal">d</mi></mpadded><mi>t</mi></mrow></mfrac><msub><mo movablelimits="false">∫</mo><mi>S</mi></msub><mover accent="true"><mi>E</mi><mo stretchy="false">⃗</mo></mover><mo>∘</mo><mover accent="true"><mi>n</mi><mo stretchy="false">^</mo></mover><mspace width="0.2778em"></mspace><mpadded lspace="0" width="+0em"><mi mathvariant="normal">d</mi></mpadded><mi>a</mi><mo fence="true" form="postfix">)</mo></mrow></mrow></math>
        </div>
      </div>
    </div>
    
    </div>
  </section>
  <div>
    <button onclick="createPermalink()" style="width: 30px; height: 30px; margin-top: 4px; border: 0.5px solid; border-radius: 5px" title="Create permalink"><svg width="16" height="16" viewBox="0 0 16 16"><!-- Generated by IcoMoon.io -->
      <path fill="#000000" d="M6.879 9.934c-0.208 0-0.416-0.079-0.575-0.238-1.486-1.486-1.486-3.905 0-5.392l3-3c0.72-0.72 1.678-1.117 2.696-1.117s1.976 0.397 2.696 1.117c1.486 1.487 1.486 3.905 0 5.392l-1.371 1.371c-0.317 0.317-0.832 0.317-1.149 0s-0.317-0.832 0-1.149l1.371-1.371c0.853-0.853 0.853-2.241 0-3.094-0.413-0.413-0.963-0.641-1.547-0.641s-1.134 0.228-1.547 0.641l-3 3c-0.853 0.853-0.853 2.241 0 3.094 0.317 0.317 0.317 0.832 0 1.149-0.159 0.159-0.367 0.238-0.575 0.238z"></path>
      <path fill="#000000" d="M4 15.813c-1.018 0-1.976-0.397-2.696-1.117-1.486-1.486-1.486-3.905 0-5.392l1.371-1.371c0.317-0.317 0.832-0.317 1.149 0s0.317 0.832 0 1.149l-1.371 1.371c-0.853 0.853-0.853 2.241 0 3.094 0.413 0.413 0.962 0.641 1.547 0.641s1.134-0.228 1.547-0.641l3-3c0.853-0.853 0.853-2.241 0-3.094-0.317-0.317-0.317-0.832 0-1.149s0.832-0.317 1.149 0c1.486 1.486 1.486 3.905 0 5.392l-3 3c-0.72 0.72-1.678 1.117-2.696 1.117z"></path>
      </svg></button>
    <span>   </span>
    <input type="checkbox" id="wide" name="wide">
    <label for="wide">Wide</label>&nbsp;
    <div style="width: 390px; float: right;">
      <div style="display: inline-block; width:35%">
        <input type="checkbox" id="displayMode" name="displayMode" checked>
        <label for="displayMode">Display Mode</label>&nbsp;<br>
        <input type="checkbox" id="annotate" name="annotate">
        <label for="annotate">Annotate</label>&nbsp;<br>
        <input type="checkbox" id="xml" name="xml" checked>
        <label for="xml">XML</label>&nbsp;
      </div>
      <div style="display: block; width: 64%; float: right;">
      <div style="display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center;">
        <select id="MathFont" onchange="updateMathFont()">
          <option value="Latin-Modern">Latin Modern</option>
          <option value="Local">Local font</option>
          <option value="Asana">Asana</option>
          <option value="STIX2">STIX TWO</option>
          <option value="Libertinus">Libertinus</option>
          <option value="Fira">Fira Math</option>
        </select>&nbsp;&nbsp;
        <select id="OutputType" onchange="reprocess()">
          <option value="Flat MML">Flat MML</option>
          <option value="MathML">MathML</option>
        </select>&nbsp;&nbsp;
        <div style="width: 200px; float: right;">
          <div style="display: inline-block; width:100%">
            <button onclick="copyMathML()" id="copy" style="width: 30px; height: 30px; margin-top: 4px; border: 0.5px solid; border-radius: 5px" title="Copy(Ctrl+Alt+c/C)"><svg width="16" height="16"><!-- Generated by IcoMoon.io -->
              <path fill="#000000" d="M10 4v-4h-7l-3 3v9h6v4h10v-12h-6zM3 1.414v1.586h-1.586l1.586-1.586zM1 11v-7h3v-3h5v3l-3 3v4h-5zM9 5.414v1.586h-1.586l1.586-1.586zM15 15h-8v-7h3v-3h5v10z"></path>
              </svg>
            </button>
            <button onclick="saveInput()" id="save" style="width: 30px; height: 30px; margin-top: 4px; border: 0.5px solid; border-radius: 5px" title="Save(Ctrl+Alt+s/S)"><svg width="16" height="16"><!-- Generated by IcoMoon.io -->
              <path fill="#000000" d="M14 0h-14v16h16v-14l-2-2zM8 2h2v4h-2v-4zM14 14h-12v-12h1v5h9v-5h1.172l0.828 0.828v11.172z"></path>
              </svg>
            </button>
            <button onclick="backHistory()" id="back" style="width: 30px; height: 30px; margin-top: 4px; border: 0.5px solid; border-radius: 5px" title="Back(Ctrl+↑)"><svg width="16" height="16"><!-- Generated by IcoMoon.io -->
              <path fill="#000000" d="M8 1c-2.209 0-4.209 0.896-5.657 2.343l-2.343-2.343v6h6l-2.243-2.243c1.086-1.086 2.586-1.757 4.243-1.757 3.314 0 6 2.686 6 6 0 1.792-0.786 3.401-2.032 4.5l1.323 1.5c1.661-1.466 2.709-3.611 2.709-6 0-4.418-3.582-8-8-8z"></path>
              </svg>
            </button>
            <button onclick="nextHistory()" id="next" style="width: 30px; height: 30px; margin-top: 4px; border: 0.5px solid; border-radius: 5px" title="Next(Ctrl+↓)"><svg width="16" height="16"><!-- Generated by IcoMoon.io -->
              <path fill="#000000" d="M0 9c0 2.389 1.048 4.534 2.709 6l1.323-1.5c-1.246-1.099-2.031-2.708-2.031-4.5 0-3.314 2.686-6 6-6 1.657 0 3.157 0.672 4.243 1.757l-2.243 2.243h6v-6l-2.343 2.343c-1.448-1.448-3.448-2.343-5.657-2.343-4.418 0-8 3.582-8 8z"></path>
              </svg>
            </button>
            <button onclick="capture()" id="capture" style="width: 30px; height: 30px; margin-top: 4px; border: 0.5px solid; border-radius: 5px" title="Capture"><svg width="16" height="16"><!-- Generated by IcoMoon.io -->
              <path fill="#000000" d="M8 9l4-4h-3v-4h-2v4h-3zM11.636 7.364l-1.121 1.121 4.064 1.515-6.579 2.453-6.579-2.453 4.064-1.515-1.121-1.121-4.364 1.636v4l8 3 8-3v-4z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>

<div id="why">
  
  <h4>一、动机</h4>
  <p>优雅地将 LaTeX 公式转换成 Microsoft Word 中的公式（xml 格式），尽管 Microsoft Word 中已有相关功能，但是非常难用，并且可能出现 bugs。</p>

</div>

<div id="why">
  <h4>二、使用方法</h4>
  <ol>
    <li>在输入栏使用 LaTeX 语法输入数学公式；</li>
    <li>勾选 XML 选项，使用 Flat MML 模式；</li>
    <li>点击 Copy 按钮或使用 Ctrl+Alt+c/C 快捷键复制内容；</li>
    <li>在 Word 中，以文本方式粘贴内容。</li>
  </ol>
</div>

<div id="why">
  <h4>三、更新内容</h4>
  <ol>
    <li>点击 Save 按钮或使用 Ctrl+Alt+s/S 快捷键保存历史输入内容（刷新浏览器后内容重置）；</li>
    <li>点击 Back (Ctrl+&uparrow;) 按钮和 Next (Ctrl+&downarrow;) 按钮访问历史保存内容；</li>
    <li>下载图片功能（还不完善）
  </ol>
</div>

<br>

</article>

<div id="copyright">大部分内容都是基于开源的<a href="https://temml.org"><u><em>Temml</em></u></a>项目</div>

<style>
  #popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 30px 40px;
    background: linear-gradient(135deg, orange, lime, brown); 
    color: white;
    font-size: 18px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    text-align: center;
    opacity: 0;
    animation: popupAnimation 1s forwards;
  }

  @keyframes popupAnimation {
    0% {
      opacity: 0;
      transform: translate(-50%, -60%);
    }
    100% {
      opacity: 1;
      transform: translate(-50%, -50%);
    }
  }

  @keyframes fadeOut {
    0% {
      opacity: 1;
    }
    100% {
      opacity: 0;
      transform: translate(-50%, -40%);
    }
  }
</style>

<div id="popup">copied!</div>

<script>
  const input = document.getElementById("demoSource");
  const mathOutput = document.getElementById('math-output');
  const katexOutput = document.getElementById('katex-output');
  const mmlOutput = document.getElementById('mml-output');
  const flatmmlOutput = document.getElementById('flatmml-output');
  const mode = document.querySelector('input[id="displayMode"]');
  const annotate = document.querySelector('input[id="annotate"]');
  const xml = document.querySelector('input[id="xml"]');
  const output = document.getElementById("OutputType");
  const popup = document.getElementById('popup');
  popup.style.display = 'none';

  const wide = document.getElementById("wide");
  const demo = document.getElementById("demo");
  wide.addEventListener('change', () => {  demo.classList.toggle("wide") });
  listenCopyKeys();
  listenSaveKeys();
  listenHistoryBrowse();
  const hash = location.hash
  let inputHistory = JSON.parse(sessionStorage.getItem('inputHistory')) || [];
  let historyIndex = inputHistory.length; // history index value
  let capturedImage = null;


  if (hash && hash.length > 1) {
    getHash()
  } else {
    if (input.value !== `\\def\\d{\\mathrm{d}}

\\oint_C \\vec{B}\\circ \\d\\vec{l} = \\mu_0 \\left( I_{\\text{enc}} + \\varepsilon_0 \\frac{\\d}{\\d t} \\int_S \\vec{E} \\circ \\hat{n}\\; \\d a \\right)`) {
    }
    reprocess()
  }

  input.addEventListener("input", reprocess, false);
  mode.addEventListener('change', () => { reprocess() });
  annotate.addEventListener('change', () => { reprocess() });
  xml.addEventListener('change', () => { reprocess() });
  window.addEventListener('hashchange', () => { getHash() }, false)
  
  function processMath() {
    mathOutput.innerHTML = "";
    temml.render(input.value, mathOutput, {
      displayMode: mode.checked,
      annotate: annotate.checked,
      xml: xml.checked
    });
    temml.postProcess(mathOutput)
  }

  function processKatex() {
    try {
        katex.render(input.value, katexOutput, {
            throwOnError: true,
            displayMode: mode.checked,
            annotate: annotate.checked,
            font: "KaTeX_Caligraphic",
        });
    } catch (e) {
        katexOutput.innerHTML = `<span style="color: red;">Error: ${e.message}</span>`;
    }
  }

  function processmml() {
    mmlOutput.innerHTML = ""
    mmlOutput.appendChild(document.createElement("pre"))
    let mml = temml.renderToString(input.value, {
      displayMode: mode.checked,
      annotate: annotate.checked,
      xml: xml.checked
    })
    const format = require('xml-formatter');
    mml = format(mml, { indentation: '  ', collapseContent: true, lineSeparator: '\n' });
    mmlOutput.firstChild.innerText = mml
  }

  function processflatmml() {
    flatmmlOutput.innerHTML = ""
    flatmmlOutput.appendChild(document.createElement("pre"))
    let flatmml = temml.renderToString(input.value, {
      displayMode: mode.checked,
      annotate: annotate.checked,
      xml: xml.checked
    })
    flatmmlOutput.firstChild.innerText = flatmml
  }

  function reprocess() {
    processMath();
    processKatex();
    processmml();
    processflatmml();
  }

  function updateMathFont() {
    // Change the CSS style sheet.
    const temmlRegEx = /assets\/Temml-.+\.css$/
    const links = [...document.head.getElementsByTagName('link')];
    links.forEach(link => {
      if (temmlRegEx.test(link.href)) {
        link.setAttribute("href", `./assets/Temml-${document.getElementById("MathFont").value}.css`);
      }
    });
  }

  function showPopup() {
    const popup = document.getElementById('popup');
    popup.style.display = 'block';
    setTimeout(() => {
      popup.style.animation = 'fadeOut 1s forwards';
    }, 1500);
    setTimeout(() => {
      popup.style.display = 'none';
    }, 800);
  }

  function saveInput() {
    const btn_save = document.getElementById("save")
    btn_save.classList.add("active-button")
    const currentValue = input.value.trim();
    if (currentValue && (inputHistory.length === 0 || inputHistory[inputHistory.length - 1] !== currentValue)) {
      inputHistory.push(currentValue);
      sessionStorage.setItem('inputHistory', JSON.stringify(inputHistory));
    }
    historyIndex = inputHistory.length; // set index
    sleep(300).then(() => {
      btn_save.classList.remove("active-button")
    });
  }

  function backHistory(){
    const btn_back = document.getElementById("back")
    btn_back.classList.add("active-button")
    if (historyIndex > 0) {
      historyIndex--;
      input.value = inputHistory[historyIndex] || '';
    }
    reprocess()
    sleep(300).then(() => {
      btn_back.classList.remove("active-button")
    });
  }

  function nextHistory(){
    const btn_next = document.getElementById("next")
    btn_next.classList.add("active-button")
    if (historyIndex < inputHistory.length - 1) {
      historyIndex++;
      input.value = inputHistory[historyIndex] || '';
    } 
    else {
      historyIndex = inputHistory.length;
      input.value = '';
    }
    reprocess()
    sleep(300).then(() => {
      btn_next.classList.remove("active-button")
    });
  }

  function sleep (time) {
    return new Promise((resolve) => setTimeout(resolve, time));
  }

  function copyMathML() {
    const btn = document.getElementById("copy")
    btn.classList.add("active-button")
    let mml = temml.renderToString(input.value, {
      displayMode: mode.checked,
      annotate: annotate.checked,
      xml: xml.checked
    })
    if (output.value !== "Flat MML") {
      const format = require('xml-formatter');
      mml = format(mml, { indentation: '  ', collapseContent: true, lineSeparator: '\n' })
    }
    navigator.clipboard.writeText(mml)
    sleep(300).then(() => {
      btn.classList.remove("active-button")
    });
    saveInput();
    showPopup();
  }

  function listenCopyKeys() {
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.altKey && event.key === 'c') {
        event.preventDefault();
        copyMathML();
      }
      else if (event.ctrlKey && event.altKey && event.key === 'C') {
        event.preventDefault();
        copyMathML();
      }
    });
  }

  function listenSaveKeys() {
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.altKey && event.key === 's') {
        event.preventDefault();
        saveInput();
      }
      else if (event.ctrlKey && event.altKey && event.key === 'S') {
        event.preventDefault();
        saveInput();
      }
    });
  }

  function listenHistoryBrowse() {
    document.addEventListener('keydown', function(event) {
      if (event.ctrlKey && event.key === 'ArrowUp') {
        event.preventDefault();
        backHistory();
      } 
      else if (event.ctrlKey && event.key === 'ArrowDown') {
        event.preventDefault();
        nextHistory();
      }
    });
  }

  const symbols = /[\r\n%#"()<>?[\\\]^`{|}]/g
  function createPermalink() {
    const tex = input.value
    if (tex && tex.length > 0) {
      location.hash = "#" + tex.replace(symbols, encodeURIComponent)
    }
  }

  function getHash() {
    const hash = location.hash
    if (hash && hash.length > 1) {
      const tex = decodeURIComponent(hash.slice(1))
      input.textContent = tex
      reprocess()
    }
  }

  function capture() {
    let divMathOutput = document.getElementById("captureArea");
    if (document.fonts) {
      document.fonts.ready.then(() => {
        html2canvas(divMathOutput, {
          useCORS: true,
          textRendering: "optimizeLegibility",
          letterRendering: true,
          allowTaint: true,
          scale: 3,
        }).then(canvas => {
          capturedImage = canvas.toDataURL("image/png");
          let link = document.createElement("a");
          link.href = capturedImage;
          link.download = "formula.png";
          link.click();
        });
      });
    } else {
      html2canvas(divMathOutput, {
        useCORS: true,
        textRendering: "optimizeLegibility",
        letterRendering: true,
        allowTaint: true,
        scale: 3,
      }).then(canvas => {
        capturedImage = canvas.toDataURL("image/png");
        let link = document.createElement("a");
        link.href = capturedImage;
        link.download = "formula.png";
        link.click();
      });
    }
  }
</script>
</main>
</body>
</html>
